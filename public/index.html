<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Coordinazione Mani con Pentagramma</title>
    <style>
        /* Stili Essenziali */
        body { display: flex; flex-direction: column; align-items: center; min-height: 100vh; background-color: #f0f0f0; margin: 0; padding-top: 20px; padding-bottom: 50px; font-family: sans-serif; }
        h1, h2 { margin-top: 25px; margin-bottom: 15px; color: #333; text-align: center; }
        #global-controls { display: flex; justify-content: center; width: 100%; margin-bottom: 20px; }

        /* --- Stili Quiz Coordinazione --- */
        .quiz-controls-group { display: flex; flex-direction: column; gap: 15px; padding: 15px; background-color: #f0f8ff; border: 1px solid #add8e6; border-radius: 5px; width: clamp(350px, 90%, 700px); box-sizing: border-box; }
        .quiz-controls-group > div { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #toggle-coordination-quiz-btn, #stop-coordination-quiz-btn { padding: 8px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; flex-shrink: 0; border: 1px solid; }
        #toggle-coordination-quiz-btn { background-color: #a2d2ff; border-color: #8ecae6; }
        #toggle-coordination-quiz-btn.quiz-active { background-color: #f8d7da; border-color: #f5c6cb; }
        #stop-coordination-quiz-btn { background-color: #ffcc80; border-color: #ffb74d; }
        #stop-coordination-quiz-btn:disabled { background-color: #cccccc; border-color: #bbbbbb; cursor: not-allowed; opacity: 0.6; }
        #coordination-quiz-options { display: none; align-items: center; gap: 15px; flex-wrap: wrap; width: 100%; }
        #coordination-quiz-options > div { display: flex; align-items: center; gap: 8px; }
        #coordination-quiz-options label { font-weight: bold; white-space: nowrap; }
        #coordination-bpm-select, #coordination-exercise-select { padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; font-size: 14px; }
        #coordination-bpm-select { width: 80px; }
        #coordination-exercise-select { flex-grow: 1; max-width: 300px; }
        #coordination-quiz-status-container { width:100%; text-align:center; margin-top: 5px; padding-top: 10px; border-top: 1px solid #ddd; }
        #coordination-quiz-status { font-weight: bold; min-width: 150px; }
        #coordination-quiz-score-display { font-weight: bold; color: darkcyan; white-space: nowrap; margin-left: auto; }

        /* --- Stili Pentagramma --- */
        #staff-container { width: 95%; max-width: 950px; margin: 20px auto 30px auto; border: 1px solid #ccc; background-color: white; padding: 10px; box-sizing: border-box; overflow-x: auto; overflow-y: hidden; min-height: 180px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #music-staff { display: block; }
        #music-staff text { font-family: 'Times New Roman', serif; dominant-baseline: middle; text-anchor: middle; user-select: none; }
        #music-staff .clef { font-family: serif; text-anchor: start; }
        .staff-line { stroke: #000; stroke-width: 1; }
        .note-head { stroke: #000; stroke-width: 1; transition: fill 0.1s ease; }
        .note-stem { stroke: #000; stroke-width: 1.2; }
        .note-flag { stroke: #000; stroke-width: 1.2; fill: none; }
        .ledger-line { stroke: #000; stroke-width: 1; }
        .note-accidental { font-size: 18px; font-weight: bold; text-anchor: middle; }
        .staff-note-highlight .note-head { fill: #ff8c00 !important; stroke: #cc7000 !important; }
        .staff-note-highlight .note-accidental { fill: #ff8c00 !important; }

        /* Stili Pianoforte */
        .piano-container { margin-top: 0; margin-bottom: 30px; width: 100%; display: flex; justify-content: center; }
        .piano { display: flex; padding: 10px; background-color: #222; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); overflow-x: auto; max-width: 95vw; }
        .key { position: relative; box-sizing: border-box; cursor: pointer; user-select: none; transition: background-color 0.1s ease; flex-shrink: 0; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; }
        .key.white { width: 50px; height: 200px; background-color: white; border: 1px solid #bbb; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; margin-right: -1px; z-index: 1; padding-bottom: 10px; font-size: 11px; font-weight: bold; color: #333; }
        .key.white:last-child { margin-right: 0; }
        .key.black { position: absolute; top: 0; left: 100%; transform: translateX(-50%); width: 30px; height: 120px; background-color: #333; border: 1px solid #222; border-top: none; border-radius: 0 0 3px 3px; z-index: 2; box-shadow: inset 0 -2px 3px rgba(255,255,255,0.2), 0 2px 3px rgba(0,0,0,0.4); padding-bottom: 5px; font-size: 9px; color: #ccc; line-height: 1.2; }

        /* Stili Evidenziazione Tasti Quiz Coordinazione */
        .key.coord-upcoming-right { background-color: #add8e6 !important; }
        .key.coord-upcoming-left { background-color: #ffb6c1 !important; }
        .key.coord-now-right { background-color: #0000ff !important; color: white !important; }
        .key.coord-now-left { background-color: #dc143c !important; color: white !important; }
        .key.coord-correct { animation: flash-green 0.3s ease-out; }
        .key.coord-incorrect-timing { animation: flash-yellow 0.4s ease-out; }
        .key.coord-incorrect-note { animation: flash-red 0.4s ease-out; }

        @keyframes flash-green { 0% { background-color: #90ee90 !important; } 100% {} }
        @keyframes flash-yellow { 0%, 100% {} 50% { background-color: #fffacd !important; } }
        @keyframes flash-red { 0%, 100% {} 50% { background-color: #ffcccb !important; } }

        /* Stili MIDI */
        #midi-controls { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; padding: 8px 12px; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; margin-top: 10px; }
        #midi-controls label { font-weight: bold; white-space: nowrap; }
        #midi-input-select { max-width: 200px; flex-shrink: 1; padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        #midi-status { font-size: 13px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

    </style>
</head>
<body>
    <h1>Quiz Coordinazione Mani</h1>

    <div id="global-controls">
        <div class="quiz-controls-group">
            {/* Riga 1: Bottoni Principali */}
            <div>
                <button id="toggle-coordination-quiz-btn">Attiva Quiz Coordinazione</button>
                <button id="stop-coordination-quiz-btn" disabled>Stop Esercizio</button>
                <span id="coordination-quiz-score-display">Punteggio: 0 | Serie: 0</span>
            </div>
            {/* Riga 2: Opzioni */}
            <div id="coordination-quiz-options" style="display: none;">
                 <div>
                     <label for="coordination-bpm-select">Velocit√† (BPM):</label>
                     <select id="coordination-bpm-select">
                         <option value="60">60</option>
                         <option value="80" selected>80</option>
                         <option value="100">100</option>
                     </select>
                 </div>
                 <div>
                     <label for="coordination-exercise-select">Esercizio:</label>
                     <select id="coordination-exercise-select">
                         <option value="random">-- Casuale --</option>
                         {/* Opzioni popolate da JS */}
                     </select>
                 </div>
            </div>
             {/* Riga 3: Status */}
             <div id="coordination-quiz-status-container">
                 <span id="coordination-quiz-status">Quiz Coordinazione non attivo.</span>
             </div>
        </div>
    </div>

    {/* MIDI Controls */}
    <div id="midi-controls">
        <label for="midi-input-select">Input MIDI:</label>
        <select id="midi-input-select" disabled><option>...</option></select>
        <span id="midi-status">Inizializzazione MIDI...</span>
    </div>

    {/* Contenitore Pentagramma */}
    <h2>Pentagramma Esercizio</h2>
    <div id="staff-container">
        <svg id="music-staff" width="900" height="180">
            <defs></defs>
            <g id="staff-lines"></g>
            <g id="notes-layer"></g>
        </svg>
    </div>

    <div class="piano-container">
        <div class="piano">
            {/* Tasti Pianoforte */}
            <div class="key white" data-midi="36" data-note="C2">C2<div class="key black" data-midi="37" data-note="C#2 / Db2"></div></div><div class="key white" data-midi="38" data-note="D2">D2<div class="key black" data-midi="39" data-note="D#2 / Eb2"></div></div><div class="key white" data-midi="40" data-note="E2">E2</div><div class="key white" data-midi="41" data-note="F2">F2<div class="key black" data-midi="42" data-note="F#2 / Gb2"></div></div><div class="key white" data-midi="43" data-note="G2">G2<div class="key black" data-midi="44" data-note="G#2 / Ab2"></div></div><div class="key white" data-midi="45" data-note="A2">A2<div class="key black" data-midi="46" data-note="A#2 / Bb2"></div></div><div class="key white" data-midi="47" data-note="B2">B2</div><div class="key white" data-midi="48" data-note="C3">C3<div class="key black" data-midi="49" data-note="C#3 / Db3"></div></div><div class="key white" data-midi="50" data-note="D3">D3<div class="key black" data-midi="51" data-note="D#3 / Eb3"></div></div><div class="key white" data-midi="52" data-note="E3">E3</div><div class="key white" data-midi="53" data-note="F3">F3<div class="key black" data-midi="54" data-note="F#3 / Gb3"></div></div><div class="key white" data-midi="55" data-note="G3">G3<div class="key black" data-midi="56" data-note="G#3 / Ab3"></div></div><div class="key white" data-midi="57" data-note="A3">A3<div class="key black" data-midi="58" data-note="A#3 / Bb3"></div></div><div class="key white" data-midi="59" data-note="B3">B3</div><div class="key white" data-midi="60" data-note="C4">C4<div class="key black" data-midi="61" data-note="C#4 / Db4"></div></div><div class="key white" data-midi="62" data-note="D4">D4<div class="key black" data-midi="63" data-note="D#4 / Eb4"></div></div><div class="key white" data-midi="64" data-note="E4">E4</div><div class="key white" data-midi="65" data-note="F4">F4<div class="key black" data-midi="66" data-note="F#4 / Gb4"></div></div><div class="key white" data-midi="67" data-note="G4">G4<div class="key black" data-midi="68" data-note="G#4 / Ab4"></div></div><div class="key white" data-midi="69" data-note="A4">A4<div class="key black" data-midi="70" data-note="A#4 / Bb4"></div></div><div class="key white" data-midi="71" data-note="B4">B4</div><div class="key white" data-midi="72" data-note="C5">C5<div class="key black" data-midi="73" data-note="C#5 / Db5"></div></div><div class="key white" data-midi="74" data-note="D5">D5<div class="key black" data-midi="75" data-note="D#5 / Eb5"></div></div><div class="key white" data-midi="76" data-note="E5">E5</div><div class="key white" data-midi="77" data-note="F5">F5<div class="key black" data-midi="78" data-note="F#5 / Gb5"></div></div><div class="key white" data-midi="79" data-note="G5">G5<div class="key black" data-midi="80" data-note="G#5 / Ab5"></div></div><div class="key white" data-midi="81" data-note="A5">A5<div class="key black" data-midi="82" data-note="A#5 / Bb5"></div></div><div class="key white" data-midi="83" data-note="B5">B5</div><div class="key white" data-midi="84" data-note="C6">C6</div>
        </div>
    </div>

<script>
    // --- Riferimenti Elementi HTML Essenziali ---
    const pianoKeys = document.querySelectorAll('.key');
    const midiInputSelect = document.getElementById('midi-input-select');
    const midiStatusDisplay = document.getElementById('midi-status');
    // --- Riferimenti Elementi HTML Quiz Coordinazione ---
    const toggleCoordinationQuizBtn = document.getElementById('toggle-coordination-quiz-btn');
    const stopCoordinationQuizBtn = document.getElementById('stop-coordination-quiz-btn');
    const coordinationQuizOptionsDiv = document.getElementById('coordination-quiz-options');
    const coordinationBpmSelect = document.getElementById('coordination-bpm-select');
    const coordinationExerciseSelect = document.getElementById('coordination-exercise-select');
    const coordinationQuizStatusDisplay = document.getElementById('coordination-quiz-status');
    const coordinationQuizScoreDisplay = document.getElementById('coordination-quiz-score-display');
    // --- Riferimenti Elementi HTML Pentagramma ---
    const staffContainer = document.getElementById('staff-container');
    const svg = document.getElementById('music-staff');
    const staffLinesGroup = document.getElementById('staff-lines');
    const notesLayer = document.getElementById('notes-layer');

    // --- Variabili Globali Essenziali ---
    let audioContext = null;
    let midiAccess = null;
    let selectedMidiInput = null;
    const SVG_NS = "http://www.w3.org/2000/svg";

    // --- Costanti Pentagramma ---
    const STAFF_HEIGHT_PER_SYSTEM = 180;
    const LINE_SPACING = 10;
    const STAFF_MARGIN_TOP = 40;
    const STAFF_GAP = 50;
    const TREBLE_STAFF_Y_BASE = STAFF_MARGIN_TOP;
    const BASS_STAFF_Y_BASE = TREBLE_STAFF_Y_BASE + 4 * LINE_SPACING + STAFF_GAP;
    const START_X = 60;
    const END_MARGIN = 30;
    const BEAT_WIDTH_STAFF = 45;
    const ACCIDENTAL_OFFSET_X = -15;

    // --- Funzioni MIDI Base ---
    function initializeMIDI() { if (navigator.requestMIDIAccess) { navigator.requestMIDIAccess({ sysex: false }).then(onMIDISuccess, onMIDIFailure); } else { midiStatusDisplay.textContent = "Web MIDI non supportato!"; midiStatusDisplay.style.color = 'red'; midiInputSelect.disabled = true; } }
    function onMIDISuccess(midiAccessObject) { midiAccess = midiAccessObject; listMidiInputs(); midiAccess.onstatechange = onMidiStateChange; }
    function onMIDIFailure(error) { console.error("Accesso MIDI fallito:", error); midiStatusDisplay.textContent = "Accesso MIDI fallito!"; midiStatusDisplay.style.color = 'red'; midiInputSelect.disabled = true; }
    function listMidiInputs() { if (!midiAccess) return; const inputs = midiAccess.inputs.values(); midiInputSelect.innerHTML = ''; let foundDevice = false; for (let input = inputs.next(); input && !input.done; input = inputs.next()) { const midiInput = input.value; const option = document.createElement('option'); option.value = midiInput.id; option.textContent = midiInput.name; midiInputSelect.appendChild(option); foundDevice = true; } if (foundDevice) { midiInputSelect.disabled = false; midiStatusDisplay.textContent = "Seleziona dispositivo"; startListeningToMidi(); } else { midiInputSelect.disabled = true; midiStatusDisplay.textContent = "Nessun input MIDI"; midiStatusDisplay.style.color = 'orange'; } }
    function onMidiStateChange(event) { listMidiInputs(); if (selectedMidiInput && selectedMidiInput.state === 'connected') { startListeningToMidi(); } else { if(selectedMidiInput && selectedMidiInput.id === event.port.id && event.port.state === 'disconnected') { selectedMidiInput = null; midiStatusDisplay.textContent = "Dispositivo scollegato"; midiStatusDisplay.style.color = 'orange'; } } }
    function startListeningToMidi() {
        if (!midiAccess) return;
        const selectedDeviceId = midiInputSelect.value;
        if (!selectedDeviceId) { midiStatusDisplay.textContent = "Nessun dispositivo valido"; return; }
        if (selectedMidiInput && selectedMidiInput.onmidimessage) { selectedMidiInput.onmidimessage = null; selectedMidiInput = null; }
        selectedMidiInput = midiAccess.inputs.get(selectedDeviceId);
        if (selectedMidiInput) {
            selectedMidiInput.onmidimessage = routeMidiMessage;
            midiStatusDisplay.textContent = `Ascoltando ${selectedMidiInput.name.substring(0, 15)}...`;
            midiStatusDisplay.style.color = 'green';
        } else {
            midiStatusDisplay.textContent = "Dispositivo non trovato";
            midiStatusDisplay.style.color = 'red';
        }
    }

    // --- Funzioni Audio Base ---
    function midiToFreq(midi) { return Math.pow(2, (midi - 69) / 12) * 440; }
    function initAudioContext() { if (audioContext) { if (audioContext.state === 'suspended') { audioContext.resume().then(() => { console.log("AudioContext ripreso."); }).catch(err => { console.error("Errore nel riprendere AudioContext:", err); }); } return; } try { window.AudioContext = window.AudioContext || window.webkitAudioContext; audioContext = new AudioContext(); console.log("AudioContext creato con successo. L'audio √® pronto."); } catch (e) { console.error("Web Audio API non supportata in questo browser.", e); alert("Il tuo browser non supporta la Web Audio API, i suoni non funzioneranno."); } }
    function playNoteSound(midiNumber, velocity = 100) { if (!audioContext) { console.warn("AudioContext non ancora inizializzato."); return; } if (audioContext.state === 'suspended') { audioContext.resume(); } if (audioContext.state !== 'running') { console.warn("AudioContext non √® in stato 'running'. Impossibile riprodurre."); return; } try { const now = audioContext.currentTime; const freq = midiToFreq(midiNumber); const oscillator = audioContext.createOscillator(); oscillator.type = 'triangle'; oscillator.frequency.setValueAtTime(freq, now); const gainNode = audioContext.createGain(); const maxGain = Math.max(0.05, Math.min(0.6, velocity / 127)); const attackTime = 0.01; const decayTime = 0.15; const sustainLevelRatio = 0.1; const releaseTime = 0.2; gainNode.gain.setValueAtTime(0, now); gainNode.gain.linearRampToValueAtTime(maxGain, now + attackTime); gainNode.gain.linearRampToValueAtTime(sustainLevelRatio * maxGain, now + attackTime + decayTime); oscillator.connect(gainNode); gainNode.connect(audioContext.destination); oscillator.start(now); const stopTime = now + attackTime + decayTime + releaseTime; gainNode.gain.linearRampToValueAtTime(0.0001, stopTime); oscillator.stop(stopTime + 0.05); } catch (error) { console.error(`Errore durante la sintesi del suono per MIDI ${midiNumber}:`, error); } }

    // --- Funzioni Helper MIDI/Note Base ---
    const note_names_quiz = ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];
    function midiToNoteNameQuiz(midi_note) { if (midi_note < 0 || midi_note > 127) return "N/A"; const note_index = midi_note % 12; const octave = Math.floor(midi_note / 12) - 1; return `${note_names_quiz[note_index]}${octave}`; }
    const midiNoteNamesSharp = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const midiNoteNamesFlat = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
    function midiToNoteDetails(midi, preference = 'sharp') { const octave = Math.floor(midi / 12) - 1; const noteIndex = midi % 12; const noteNameArray = (preference === 'flat') ? midiNoteNamesFlat : midiNoteNamesSharp; const noteName = noteNameArray[noteIndex]; const letter = noteName[0]; const accidental = noteName.length > 1 ? noteName.substring(1) : null; return { midi, octave, noteIndex, noteName, letter, accidental, preference }; }
    const noteNameToStep = { 'c': 0, 'd': 1, 'e': 2, 'f': 3, 'g': 4, 'a': 5, 'b': 6 };
    function getDiatonicStepsFromC0(midi, preference = 'sharp') { const details = midiToNoteDetails(midi, preference); const octaveSteps = (details.octave) * 7; const baseStepsWithinOctave = noteNameToStep[details.letter.toLowerCase()]; return octaveSteps + baseStepsWithinOctave; }

    // --- Funzioni Disegno Pentagramma ---
    function createSvgElement(name, attributes) { const element = document.createElementNS(SVG_NS, name); for (const key in attributes) { element.setAttributeNS(null, key, attributes[key]); } return element; }

    function drawStaffSystemHelper(yOffset, width) {
        staffLinesGroup.innerHTML = '';
        const systemGroup = createSvgElement('g', { transform: `translate(0, ${yOffset})` });
        staffLinesGroup.appendChild(systemGroup);
        function drawPentagramLines(baseY) { for (let i = 0; i < 5; i++) { const y = baseY + i * LINE_SPACING; const line = createSvgElement('line', { x1: 10, y1: y, x2: width - 10, y2: y, class: 'staff-line' }); systemGroup.appendChild(line); } }
        drawPentagramLines(TREBLE_STAFF_Y_BASE); drawPentagramLines(BASS_STAFF_Y_BASE);
        const connectLine = createSvgElement('line', { x1: 15, y1: TREBLE_STAFF_Y_BASE, x2: 15, y2: BASS_STAFF_Y_BASE + 4 * LINE_SPACING, class: 'staff-line', 'stroke-width': 1.5 }); systemGroup.appendChild(connectLine);
        const trebleClef = createSvgElement('text', { x: 25, y: TREBLE_STAFF_Y_BASE + 1.5 * LINE_SPACING, 'font-size': LINE_SPACING * 4.5, class: 'clef' }); trebleClef.textContent = 'ùÑû'; systemGroup.appendChild(trebleClef);
        const bassClef = createSvgElement('text', { x: 25, y: BASS_STAFF_Y_BASE + 1 * LINE_SPACING, 'font-size': LINE_SPACING * 3.5, class: 'clef' }); bassClef.textContent = 'ùÑ¢'; systemGroup.appendChild(bassClef);
        const finalBarline = createSvgElement('line', { x1: width - 10, y1: TREBLE_STAFF_Y_BASE, x2: width - 10, y2: BASS_STAFF_Y_BASE + 4 * LINE_SPACING, class: 'staff-line', 'stroke-width': 1.5 }); systemGroup.appendChild(finalBarline);
    }

    function midiToYPositionRelativeToContext(midi, contextClef, preference = 'sharp') {
        const stepsFromC0 = getDiatonicStepsFromC0(midi, preference);
        let referenceMidi, referenceStepsFromC0, referenceYBase, staffYBase;
        if (contextClef === 'treble') { referenceMidi = 71; referenceStepsFromC0 = getDiatonicStepsFromC0(referenceMidi, preference); referenceYBase = TREBLE_STAFF_Y_BASE + 0 * LINE_SPACING; staffYBase = TREBLE_STAFF_Y_BASE; }
        else if (contextClef === 'bass') { referenceMidi = 50; referenceStepsFromC0 = getDiatonicStepsFromC0(referenceMidi, preference); referenceYBase = BASS_STAFF_Y_BASE + 2 * LINE_SPACING; staffYBase = BASS_STAFF_Y_BASE; }
        else { console.error("Clef non valida:", contextClef); return null; }
        const stepDifference = stepsFromC0 - referenceStepsFromC0;
        const yPosition = referenceYBase - (stepDifference * (LINE_SPACING / 2));
        const middleLineY = staffYBase + 2 * LINE_SPACING;
        const stemUp = yPosition >= middleLineY;
        return { yBase: yPosition, stemUp: stemUp };
    }

    function drawLedgerLines(x, y, contextClef, yOffset) {
        const ledgerGroup = createSvgElement('g', { class: 'ledger-lines' });
        const ledgerWidth = LINE_SPACING * 1.8; const noteHeadRadius = LINE_SPACING / 2.5;
        const staffTopY = ((contextClef === 'treble') ? TREBLE_STAFF_Y_BASE : BASS_STAFF_Y_BASE) + yOffset;
        const staffBottomY = staffTopY + 4 * LINE_SPACING; const noteAbsoluteY = y + yOffset;
        let currentLineY = staffTopY - LINE_SPACING;
        while (currentLineY >= noteAbsoluteY - noteHeadRadius / 2) { const line = createSvgElement('line', { x1: x - ledgerWidth / 2, y1: currentLineY, x2: x + ledgerWidth / 2, y2: currentLineY, class: 'ledger-line' }); ledgerGroup.appendChild(line); currentLineY -= LINE_SPACING; }
        currentLineY = staffBottomY + LINE_SPACING;
        while (currentLineY <= noteAbsoluteY + noteHeadRadius / 2) { const line = createSvgElement('line', { x1: x - ledgerWidth / 2, y1: currentLineY, x2: x + ledgerWidth / 2, y2: currentLineY, class: 'ledger-line' }); ledgerGroup.appendChild(line); currentLineY += LINE_SPACING; }
        return ledgerGroup;
    }

    function drawNoteOnStaff(x, yData, midi, noteData, yOffset, contextClef, parentLayer = notesLayer) {
        const noteGroup = createSvgElement('g', { class: 'note-element', 'data-midi': midi });
        const yBase = yData.yBase; const yAbsolute = yBase + yOffset; let accidentalSymbol = '';
        if (noteData.accidental) {
            switch (noteData.accidental) { case 'sharp': case '#': accidentalSymbol = '‚ôØ'; break; case 'flat': case 'b': accidentalSymbol = '‚ô≠'; break; }
            if (accidentalSymbol) { const accidentalText = createSvgElement('text', { x: x + ACCIDENTAL_OFFSET_X, y: yAbsolute, class: 'note-accidental' }); accidentalText.textContent = accidentalSymbol; noteGroup.appendChild(accidentalText); }
        }
        const ledgerLines = drawLedgerLines(x, yBase, contextClef, yOffset); noteGroup.appendChild(ledgerLines);
        const noteHeadRadius = LINE_SPACING / 2.5;
        const noteHead = createSvgElement('ellipse', { cx: x, cy: yAbsolute, rx: noteHeadRadius * 1.2, ry: noteHeadRadius, fill: 'black', stroke: 'black', 'stroke-width': 1, class: 'note-head' });
        noteHead.setAttributeNS(null, 'transform', `rotate(-15 ${x} ${yAbsolute})`); noteGroup.appendChild(noteHead);
        parentLayer.appendChild(noteGroup);
        return { group: noteGroup };
    }

    function drawExerciseOnStaff(exercise) {
        if (!svg || !notesLayer || !exercise || !exercise.notes) return;
        notesLayer.innerHTML = '';
        let maxTime = 0;
        if (exercise.notes.length > 0) { maxTime = Math.max(...exercise.notes.map(n => n.time + n.duration)); }
        const requiredWidth = START_X + maxTime * BEAT_WIDTH_STAFF + END_MARGIN;
        svg.setAttribute('width', requiredWidth); svg.setAttribute('height', STAFF_HEIGHT_PER_SYSTEM);
        drawStaffSystemHelper(0, requiredWidth);

        notesInExerciseState.forEach(noteState => {
            const note = noteState;
            const contextClef = note.hand === 'left' ? 'bass' : 'treble';
            const yData = midiToYPositionRelativeToContext(note.midi, contextClef);
            if (!yData) { console.warn(`Impossibile calcolare Y per MIDI ${note.midi} in clef ${contextClef}`); return; }
            const xPos = START_X + note.time * BEAT_WIDTH_STAFF;
            const noteDetails = midiToNoteDetails(note.midi);
            const noteDrawData = { value: 'quarter', accidental: noteDetails.accidental };
            const noteDrawResult = drawNoteOnStaff(xPos, yData, note.midi, noteDrawData, 0, contextClef, notesLayer);
            noteState.svgElement = noteDrawResult.group;
        });
        console.log(`Esercizio "${exercise.name}" disegnato sul pentagramma.`);
    }

    function updateStaffHighlight(elapsedSeconds) {
        if (!isExerciseRunning) return;
        notesInExerciseState.forEach(noteState => {
            if (noteState.svgElement) {
                const noteStartTime = noteState.startTimeSeconds; const noteEndTime = noteState.endTimeSeconds;
                const isDue = elapsedSeconds >= noteStartTime && elapsedSeconds < noteEndTime;
                if (isDue) { noteState.svgElement.classList.add('staff-note-highlight'); }
                else { noteState.svgElement.classList.remove('staff-note-highlight'); }
            }
        });
    }

    function clearStaffHighlight() { notesInExerciseState.forEach(noteState => { if (noteState.svgElement) { noteState.svgElement.classList.remove('staff-note-highlight'); } }); }
    function clearStaff() { notesLayer.innerHTML = ''; }

    // ==================================================
    // === INIZIO DATI QUIZ COORDINAZIONE MANI =========
    // ==================================================
    const coordinationExercises = [
        // --- Esercizi Originali ---
        { name: "1A: LH Statica, RH Mobile", notes: [ { midi: 48, time: 0.0, duration: 4.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 62, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 64, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 65, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 43, time: 4.0, duration: 4.0, hand: 'left' }, { midi: 67, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 65, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 64, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 62, time: 7.0, duration: 1.0, hand: 'right' }, ] },
        { name: "1B: RH Statica, LH Mobile", notes: [ { midi: 67, time: 0.0, duration: 4.0, hand: 'right' }, { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 50, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 52, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 53, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 72, time: 4.0, duration: 4.0, hand: 'right' }, { midi: 55, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 53, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 52, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 50, time: 7.0, duration: 1.0, hand: 'left' }, ] },
        { name: "2: Moto Contrario (5+3)", notes: [ { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 60, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 59, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 57, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 53, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 57, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 7.0, duration: 1.0, hand: 'right' }, { midi: 59, time: 7.0, duration: 1.0, hand: 'left' }, ] },
        { name: "3A: Ritmo 2:1", notes: [ { midi: 48, time: 0.0, duration: 2.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 62, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 2.0, duration: 2.0, hand: 'left' }, { midi: 64, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 65, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 48, time: 4.0, duration: 2.0, hand: 'left' }, { midi: 67, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 65, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 6.0, duration: 2.0, hand: 'left' }, { midi: 64, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 62, time: 7.0, duration: 1.0, hand: 'right' }, ] },
        { name: "3B: Ritmo Puntato", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 1.5, hand: 'right' }, { midi: 52, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 1.5, duration: 0.5, hand: 'right' }, { midi: 55, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 2.0, duration: 1.5, hand: 'right' }, { midi: 52, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 3.5, duration: 0.5, hand: 'right' }, { midi: 48, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 4.0, duration: 1.5, hand: 'right' }, { midi: 52, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 5.5, duration: 0.5, hand: 'right' }, { midi: 55, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 6.0, duration: 1.5, hand: 'right' }, { midi: 52, time: 7.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 7.5, duration: 0.5, hand: 'right' }, ] },
        { name: "4: Ostinato LH", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 0.0, duration: 2.0, hand: 'right' }, { midi: 55, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 52, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 2.0, duration: 2.0, hand: 'right' }, { midi: 55, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 48, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 4.0, duration: 2.0, hand: 'right' }, { midi: 55, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 52, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 6.0, duration: 2.0, hand: 'right' }, { midi: 55, time: 7.0, duration: 1.0, hand: 'left' }, { midi: 48, time: 8.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 8.0, duration: 4.0, hand: 'right' }, { midi: 55, time: 9.0, duration: 1.0, hand: 'left' }, { midi: 52, time: 10.0, duration: 1.0, hand: 'left' }, { midi: 55, time: 11.0, duration: 1.0, hand: 'left' }, ] },
        { name: "5: Arpeggio Do Magg. (Diviso)", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 72, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 67, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 52, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 48, time: 7.0, duration: 1.0, hand: 'left' }, ] },
        { name: "6: Accordo Spezzato Sol Magg.", notes: [ { midi: 43, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 59, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 74, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 67, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 59, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 71, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 43, time: 7.0, duration: 1.0, hand: 'left' }, ] },
        { name: "7: Scala Parallela (Do-Mi)", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 52, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 48, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 52, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 53, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 52, time: 7.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 7.0, duration: 1.0, hand: 'right' }, ] },
        { name: "8: Scala Contraria (Do-Sol)", notes: [ { midi: 60, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 59, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 57, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 57, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 59, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 60, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 60, time: 7.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 7.0, duration: 1.0, hand: 'right' }, ] },
        { name: "9: Incrocio Semplice (LH over RH)", notes: [ { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 64, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 53, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 57, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 7.0, duration: 1.0, hand: 'right' }, ] },
        { name: "10: Incrocio Semplice (RH over LH)", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 52, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 53, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 52, time: 7.0, duration: 1.0, hand: 'left' }, ] },
        { name: "11: Frammenti Arpeggio Alternati (Do Magg)", notes: [ { midi: 48, time: 0.0, duration: 0.5, hand: 'left' }, { midi: 52, time: 0.5, duration: 0.5, hand: 'left' }, { midi: 67, time: 1.0, duration: 0.5, hand: 'right' }, { midi: 72, time: 1.5, duration: 0.5, hand: 'right' }, { midi: 55, time: 2.0, duration: 0.5, hand: 'left' }, { midi: 60, time: 2.5, duration: 0.5, hand: 'left' }, { midi: 72, time: 3.0, duration: 0.5, hand: 'right' }, { midi: 76, time: 3.5, duration: 0.5, hand: 'right' }, { midi: 60, time: 4.0, duration: 0.5, hand: 'left' }, { midi: 55, time: 4.5, duration: 0.5, hand: 'left' }, { midi: 72, time: 5.0, duration: 0.5, hand: 'right' }, { midi: 67, time: 5.5, duration: 0.5, hand: 'right' }, { midi: 52, time: 6.0, duration: 0.5, hand: 'left' }, { midi: 48, time: 6.5, duration: 0.5, hand: 'left' }, { midi: 67, time: 7.0, duration: 0.5, hand: 'right' }, { midi: 64, time: 7.5, duration: 0.5, hand: 'right' }, ] },
        { name: "12: Accordo LH + Arpeggio RH", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 48, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 43, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 71, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 43, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 74, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 7.0, duration: 1.0, hand: 'left' }, { midi: 71, time: 7.0, duration: 1.0, hand: 'right' }, ] },
        { name: "13: Basso Albertino LH + Melodia RH", notes: [ { midi: 48, time: 0.0, duration: 0.5, hand: 'left' }, { midi: 64, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 0.5, duration: 0.5, hand: 'left' }, { midi: 52, time: 1.0, duration: 0.5, hand: 'left' }, { midi: 65, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 1.5, duration: 0.5, hand: 'left' }, { midi: 48, time: 2.0, duration: 0.5, hand: 'left' }, { midi: 67, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 2.5, duration: 0.5, hand: 'left' }, { midi: 52, time: 3.0, duration: 0.5, hand: 'left' }, { midi: 64, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 3.5, duration: 0.5, hand: 'left' }, { midi: 43, time: 4.0, duration: 0.5, hand: 'left' }, { midi: 74, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 4.5, duration: 0.5, hand: 'left' }, { midi: 47, time: 5.0, duration: 0.5, hand: 'left' }, { midi: 72, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 5.5, duration: 0.5, hand: 'left' }, { midi: 43, time: 6.0, duration: 0.5, hand: 'left' }, { midi: 71, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 6.5, duration: 0.5, hand: 'left' }, { midi: 47, time: 7.0, duration: 0.5, hand: 'left' }, { midi: 69, time: 7.0, duration: 1.0, hand: 'right' }, { midi: 50, time: 7.5, duration: 0.5, hand: 'left' }, ] },
        { name: "14: Sincope Semplice RH vs LH", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 0.0, duration: 0.5, hand: 'right' }, { midi: 65, time: 0.5, duration: 1.0, hand: 'right' }, { midi: 55, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 1.5, duration: 0.5, hand: 'right' }, { midi: 48, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 69, time: 2.0, duration: 0.5, hand: 'right' }, { midi: 67, time: 2.5, duration: 1.0, hand: 'right' }, { midi: 55, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 65, time: 3.5, duration: 0.5, hand: 'right' }, { midi: 41, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 48, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 5.0, duration: 0.5, hand: 'right' }, { midi: 60, time: 5.5, duration: 1.0, hand: 'right' }, { midi: 41, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 62, time: 6.5, duration: 0.5, hand: 'right' }, { midi: 48, time: 7.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 7.0, duration: 1.0, hand: 'right' }, ] },
        // --- Esercizi Aggiunti ---
        { name: "15: Arpeggio Prog. (C-F-G-C)", notes: [ { midi: 48, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 72, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 53, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 72, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 60, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 77, time: 7.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 8.0, duration: 1.0, hand: 'left' }, { midi: 74, time: 9.0, duration: 1.0, hand: 'right' }, { midi: 62, time: 10.0, duration: 1.0, hand: 'left' }, { midi: 79, time: 11.0, duration: 1.0, hand: 'right' }, { midi: 60, time: 12.0, duration: 1.0, hand: 'left' }, { midi: 76, time: 13.0, duration: 1.0, hand: 'right' }, { midi: 67, time: 14.0, duration: 1.0, hand: 'left' }, { midi: 72, time: 15.0, duration: 1.0, hand: 'right' }, ]},
        { name: "16: Broken Chords (C-Am-F-G)", notes: [ { midi: 48, time: 0.0, duration: 0.5, hand: 'left' }, { midi: 60, time: 0.0, duration: 2.0, hand: 'right' }, { midi: 55, time: 0.5, duration: 0.5, hand: 'left' }, { midi: 60, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 45, time: 2.0, duration: 0.5, hand: 'left' }, { midi: 69, time: 2.0, duration: 2.0, hand: 'right' }, { midi: 52, time: 2.5, duration: 0.5, hand: 'left' }, { midi: 57, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 41, time: 4.0, duration: 0.5, hand: 'left' }, { midi: 65, time: 4.0, duration: 2.0, hand: 'right' }, { midi: 48, time: 4.5, duration: 0.5, hand: 'left' }, { midi: 53, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 43, time: 6.0, duration: 0.5, hand: 'left' }, { midi: 67, time: 6.0, duration: 2.0, hand: 'right' }, { midi: 50, time: 6.5, duration: 0.5, hand: 'left' }, { midi: 55, time: 7.0, duration: 1.0, hand: 'left' }, ]},
        { name: "17: Scale Alternation (C Maj)", notes: [ { midi: 60, time: 0.0, duration: 0.5, hand: 'right' }, { midi: 62, time: 0.5, duration: 0.5, hand: 'right' }, { midi: 53, time: 1.0, duration: 0.5, hand: 'left' }, { midi: 55, time: 1.5, duration: 0.5, hand: 'left' }, { midi: 64, time: 2.0, duration: 0.5, hand: 'right' }, { midi: 65, time: 2.5, duration: 0.5, hand: 'right' }, { midi: 57, time: 3.0, duration: 0.5, hand: 'left' }, { midi: 59, time: 3.5, duration: 0.5, hand: 'left' }, { midi: 67, time: 4.0, duration: 0.5, hand: 'right' }, { midi: 69, time: 4.5, duration: 0.5, hand: 'right' }, { midi: 60, time: 5.0, duration: 0.5, hand: 'left' }, { midi: 62, time: 5.5, duration: 0.5, hand: 'left' }, { midi: 71, time: 6.0, duration: 0.5, hand: 'right' }, { midi: 72, time: 6.5, duration: 0.5, hand: 'right' }, { midi: 64, time: 7.0, duration: 0.5, hand: 'left' }, { midi: 65, time: 7.5, duration: 0.5, hand: 'left' }, ]},
        { name: "18: Contrary Arpeggios (C Maj)", notes: [ { midi: 60, time: 0.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 1.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 1.0, duration: 1.0, hand: 'right' }, { midi: 52, time: 2.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 2.0, duration: 1.0, hand: 'right' }, { midi: 48, time: 3.0, duration: 1.0, hand: 'left' }, { midi: 72, time: 3.0, duration: 1.0, hand: 'right' }, { midi: 52, time: 4.0, duration: 1.0, hand: 'left' }, { midi: 67, time: 4.0, duration: 1.0, hand: 'right' }, { midi: 55, time: 5.0, duration: 1.0, hand: 'left' }, { midi: 64, time: 5.0, duration: 1.0, hand: 'right' }, { midi: 60, time: 6.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 6.0, duration: 1.0, hand: 'right' }, { midi: 60, time: 7.0, duration: 1.0, hand: 'left' }, { midi: 60, time: 7.0, duration: 1.0, hand: 'right' }, ]},
        { name: "19: Polyrhythm Prep (3 vs 2)", notes: [ { midi: 48, time: 0.0, duration: 2.0, hand: 'left' }, { midi: 60, time: 0.0, duration: 0.66, hand: 'right' }, { midi: 62, time: 0.66, duration: 0.67, hand: 'right'}, { midi: 64, time: 1.33, duration: 0.67, hand: 'right'}, { midi: 55, time: 2.0, duration: 2.0, hand: 'left' }, { midi: 65, time: 2.0, duration: 0.66, hand: 'right' }, { midi: 64, time: 2.66, duration: 0.67, hand: 'right'}, { midi: 62, time: 3.33, duration: 0.67, hand: 'right'}, { midi: 48, time: 4.0, duration: 2.0, hand: 'left' }, { midi: 60, time: 4.0, duration: 0.66, hand: 'right' }, { midi: 62, time: 4.66, duration: 0.67, hand: 'right'}, { midi: 64, time: 5.33, duration: 0.67, hand: 'right'}, { midi: 55, time: 6.0, duration: 2.0, hand: 'left' }, { midi: 65, time: 6.0, duration: 0.66, hand: 'right' }, { midi: 64, time: 6.66, duration: 0.67, hand: 'right'}, { midi: 62, time: 7.33, duration: 0.67, hand: 'right'}, ]},
        { name: "20: Chromatic Alternation", notes: [ { midi: 60, time: 0.0, duration: 0.5, hand: 'right' }, { midi: 61, time: 0.5, duration: 0.5, hand: 'right' }, { midi: 51, time: 1.0, duration: 0.5, hand: 'left' }, { midi: 52, time: 1.5, duration: 0.5, hand: 'left' }, { midi: 62, time: 2.0, duration: 0.5, hand: 'right' }, { midi: 63, time: 2.5, duration: 0.5, hand: 'right' }, { midi: 53, time: 3.0, duration: 0.5, hand: 'left' }, { midi: 54, time: 3.5, duration: 0.5, hand: 'left' }, { midi: 64, time: 4.0, duration: 0.5, hand: 'right' }, { midi: 63, time: 4.5, duration: 0.5, hand: 'right' }, { midi: 55, time: 5.0, duration: 0.5, hand: 'left' }, { midi: 54, time: 5.5, duration: 0.5, hand: 'left' }, { midi: 62, time: 6.0, duration: 0.5, hand: 'right' }, { midi: 61, time: 6.5, duration: 0.5, hand: 'right' }, { midi: 52, time: 7.0, duration: 0.5, hand: 'left' }, { midi: 51, time: 7.5, duration: 0.5, hand: 'left' }, ]}
    ];
    // ================================================
    // === FINE DATI QUIZ COORDINAZIONE MANI =========
    // ================================================

    // =====================================================
    // === VARIABILI STATO QUIZ COORDINAZIONE =============
    // =====================================================
    let isCoordinationQuizActive = false;
    let currentCoordinationExercise = null;
    let coordinationQuizBPM = 80;
    let coordinationQuizStartTime = 0;
    let coordinationQuizCurrentBeat = 0;
    let coordinationQuizIntervalId = null;
    let coordinationQuizScore = 0;
    let coordinationQuizStreak = 0;
    let metronomeIntervalId = null;
    const upcomingNoteLookahead = 0.5;
    const timingTolerancePerfect = 0.15;
    const timingToleranceGood = 0.30;
    let notesInExerciseState = [];
    const coordinationRepetitionTarget = 10;
    let coordinationCurrentRepetition = 0;
    let isExerciseRunning = false;
    // ================================================
    // === FINE VARIABILI STATO QUIZ COORDINAZIONE ===
    // ================================================

    // =====================================================
    // === INIZIO CODICE QUIZ COORDINAZIONE MANI ==========
    // =====================================================

    function populateExerciseSelect() {
        coordinationExerciseSelect.innerHTML = '<option value="random">-- Casuale --</option>';
        coordinationExercises.forEach((exercise, index) => {
            const option = document.createElement('option');
            option.value = index.toString();
            option.textContent = exercise.name;
            option.title = exercise.name;
            coordinationExerciseSelect.appendChild(option);
        });
    }

    function updateCoordinationScoreDisplay() {
        if (coordinationQuizScoreDisplay) {
            coordinationQuizScoreDisplay.textContent = `Punteggio: ${coordinationQuizScore} | Serie: ${coordinationQuizStreak}`;
        }
    }

    function prepareCurrentExerciseState() {
        if (!currentCoordinationExercise) return;
        coordinationQuizBPM = parseInt(coordinationBpmSelect.value, 10) || 80;
        notesInExerciseState = currentCoordinationExercise.notes.map((note, index) => ({
            ...note,
            id: `coordNote-${index}-${coordinationCurrentRepetition}`,
            state: 'pending',
            playedTimestamp: null,
            timingDifference: null,
            isCorrectNote: null,
            startTimeSeconds: (note.time / coordinationQuizBPM) * 60,
            endTimeSeconds: ((note.time + note.duration) / coordinationQuizBPM) * 60,
            svgElement: null
        }));
        console.log(`Stato preparato per l'esercizio ${currentCoordinationExercise.name}, ripetizione ${coordinationCurrentRepetition + 1} a ${coordinationQuizBPM} BPM`);
        drawExerciseOnStaff(currentCoordinationExercise);
    }

    function restartCurrentCoordinationExercise() {
        if (!isCoordinationQuizActive || !currentCoordinationExercise) return;
        stopCoordinationTiming();
        coordinationCurrentRepetition++;
        console.log(`Riavvio esercizio ${currentCoordinationExercise.name} per ripetizione ${coordinationCurrentRepetition + 1}/${coordinationRepetitionTarget}`);
        prepareCurrentExerciseState();
        coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise.name} - Ripetizione ${coordinationCurrentRepetition + 1}/${coordinationRepetitionTarget}. Via!`;
        coordinationQuizStatusDisplay.style.color = 'blue';
        startCoordinationTiming();
    }

    function selectNextCoordinationExercise() {
        if (!isCoordinationQuizActive || coordinationExercises.length === 0) return;
        stopCoordinationTiming();
        console.log("Selezione nuovo esercizio di coordinazione...");
        coordinationCurrentRepetition = 0;

        const selectedValue = coordinationExerciseSelect.value;
        let exerciseIndex = -1;

        if (selectedValue === "random") {
            exerciseIndex = Math.floor(Math.random() * coordinationExercises.length);
            console.log("Esercizio selezionato casualmente.");
        } else {
            exerciseIndex = parseInt(selectedValue, 10);
            if (exerciseIndex < 0 || exerciseIndex >= coordinationExercises.length) {
                console.error("Indice esercizio selezionato non valido, seleziono casualmente.");
                exerciseIndex = Math.floor(Math.random() * coordinationExercises.length);
                coordinationExerciseSelect.value = "random";
            } else {
                 console.log(`Esercizio selezionato: ${coordinationExercises[exerciseIndex].name}`);
            }
        }
        currentCoordinationExercise = coordinationExercises[exerciseIndex];

        if (!currentCoordinationExercise) {
            console.error("Errore critico: Esercizio non trovato!");
            coordinationQuizStatusDisplay.textContent = "Errore: Dati esercizio mancanti.";
            coordinationQuizStatusDisplay.style.color = 'red';
            return;
        }

        prepareCurrentExerciseState();

        coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise.name} - Ripetizione ${coordinationCurrentRepetition + 1}/${coordinationRepetitionTarget}. Pronto?`;
        coordinationQuizStatusDisplay.style.color = 'blue';
        updateCoordinationScoreDisplay();
        console.log(`Nuovo Esercizio Coordinazione: ${currentCoordinationExercise.name} a ${coordinationQuizBPM} BPM (Ripetizione 1/${coordinationRepetitionTarget})`);
        startCoordinationTiming();
    }

    function toggleCoordinationQuizMode() {
        isCoordinationQuizActive = !isCoordinationQuizActive;

        if (isCoordinationQuizActive) {
            coordinationQuizScore = 0;
            coordinationQuizStreak = 0;
            updateCoordinationScoreDisplay();
            toggleCoordinationQuizBtn.textContent = "Disattiva Quiz Coordinazione";
            toggleCoordinationQuizBtn.classList.add('quiz-active');
            coordinationQuizOptionsDiv.style.display = 'flex';
            console.log("Modalit√† Quiz Coordinazione ATTIVATA");
            disableQuizInteractions(false);

            selectNextCoordinationExercise();

        } else {
            toggleCoordinationQuizBtn.textContent = "Attiva Quiz Coordinazione";
            toggleCoordinationQuizBtn.classList.remove('quiz-active');
            coordinationQuizOptionsDiv.style.display = 'none';
            coordinationQuizStatusDisplay.textContent = "Quiz Coordinazione non attivo.";
            console.log("Modalit√† Quiz Coordinazione DISATTIVATA");
            stopCoordinationTiming();
            clearPianoKeyHighlights();
            clearStaffHighlight();
            clearStaff();
            enableQuizInteractions();
            isExerciseRunning = false;
        }
    }

    function handleStopButtonClick() {
        if (!isCoordinationQuizActive || !isExerciseRunning) return;
        console.log("Bottone Stop premuto.");
        stopCoordinationTiming();
        clearPianoKeyHighlights();
        clearStaffHighlight();
        coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise?.name || ''} - Fermato.`;
        coordinationQuizStatusDisplay.style.color = 'grey';
        isExerciseRunning = false;
        enableQuizInteractions(); // Riabilita controlli (tranne Stop stesso)
    }

    function startCoordinationTiming() {
        if (coordinationQuizIntervalId) clearInterval(coordinationQuizIntervalId);
        if (metronomeIntervalId) clearInterval(metronomeIntervalId);

        coordinationQuizBPM = parseInt(coordinationBpmSelect.value, 10) || 80;
        console.log(`Avvio Timing Quiz Coordinazione a ${coordinationQuizBPM} BPM...`);
        coordinationQuizStartTime = performance.now();
        coordinationQuizCurrentBeat = 0;
        isExerciseRunning = true;
        stopCoordinationQuizBtn.disabled = false;

        const beatDurationSeconds = 60.0 / coordinationQuizBPM;
        if (beatDurationSeconds > 0) {
            metronomeIntervalId = setInterval(() => {
                if (!isCoordinationQuizActive || !isExerciseRunning) { clearInterval(metronomeIntervalId); return; }
                playMetronomeClick();
            }, beatDurationSeconds * 1000);
            playMetronomeClick();
        } else { console.warn("BPM non validi, metronomo non avviato."); }

        const loopIntervalMs = 50;
        coordinationQuizIntervalId = setInterval(() => {
            if (!isCoordinationQuizActive || !isExerciseRunning) { clearInterval(coordinationQuizIntervalId); return; }
            coordinationQuizLoop();
        }, loopIntervalMs);
    }

    function stopCoordinationTiming() {
        console.log("Stop Timing Quiz Coordinazione.");
        if (coordinationQuizIntervalId) clearInterval(coordinationQuizIntervalId);
        if (metronomeIntervalId) clearInterval(metronomeIntervalId);
        coordinationQuizIntervalId = null;
        metronomeIntervalId = null;
        isExerciseRunning = false;
        stopCoordinationQuizBtn.disabled = true;
    }

    function playMetronomeClick() {
        if (!audioContext || audioContext.state !== 'running') { initAudioContext(); if (!audioContext || audioContext.state !== 'running') return; }
        try {
            const osc = audioContext.createOscillator(); const gain = audioContext.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioContext.currentTime);
            gain.gain.setValueAtTime(0.3, audioContext.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime + 0.05);
        } catch (e) { console.error("Errore riproduzione metronomo:", e); }
    }

    function coordinationQuizLoop() {
        const now = performance.now();
        const elapsedMs = now - coordinationQuizStartTime;
        const elapsedSeconds = elapsedMs / 1000.0;
        const currentLoopBPM = parseInt(coordinationBpmSelect.value, 10) || 80;
        if (currentLoopBPM > 0) { coordinationQuizCurrentBeat = (elapsedSeconds * currentLoopBPM) / 60.0; }
        else { coordinationQuizCurrentBeat = 0; }

        updateCoordinationKeyboardVisuals(elapsedSeconds);
        updateStaffHighlight(elapsedSeconds);

        if (notesInExerciseState.length > 0) {
             const lastNote = notesInExerciseState[notesInExerciseState.length - 1];
             const lastNoteEndTimeSeconds = lastNote.endTimeSeconds;
             const endBufferSeconds = 0.5;

             if (elapsedSeconds > lastNoteEndTimeSeconds + endBufferSeconds) {
                 console.log(`Ripetizione ${coordinationCurrentRepetition + 1} di ${currentCoordinationExercise.name} finita (tempo scaduto).`);
                 stopCoordinationTiming();

                 if (coordinationCurrentRepetition < coordinationRepetitionTarget - 1) {
                     coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise.name} - Ripetizione ${coordinationCurrentRepetition + 1} completata. Preparo la prossima...`;
                     coordinationQuizStatusDisplay.style.color = 'blue';
                     setTimeout(restartCurrentCoordinationExercise, 1500);
                 } else {
                     coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise.name} - Completate ${coordinationRepetitionTarget} ripetizioni! Carico il prossimo...`;
                     coordinationQuizStatusDisplay.style.color = 'green';
                     console.log(`Completate tutte le ${coordinationRepetitionTarget} ripetizioni per ${currentCoordinationExercise.name}. Seleziono il prossimo.`);
                     setTimeout(selectNextCoordinationExercise, 2500);
                 }
             }
        }
    }

    function updateCoordinationKeyboardVisuals(elapsedSeconds) {
        clearPianoKeyHighlights();
        const lookaheadSeconds = coordinationQuizBPM > 0 ? (upcomingNoteLookahead / coordinationQuizBPM) * 60 : 0.1;

        notesInExerciseState.forEach(noteState => {
            const noteStartTime = noteState.startTimeSeconds;
            const noteEndTime = noteState.endTimeSeconds;

            if (noteState.state === 'pending' || noteState.state === 'upcoming' || noteState.state === 'due') {
                if (elapsedSeconds >= noteStartTime && elapsedSeconds < noteEndTime) {
                    noteState.state = 'due';
                    highlightPianoKey(noteState.midi, `coord-now-${noteState.hand}`);
                }
                else if (elapsedSeconds >= noteStartTime - lookaheadSeconds && elapsedSeconds < noteStartTime) {
                    noteState.state = 'upcoming';
                    highlightPianoKey(noteState.midi, `coord-upcoming-${noteState.hand}`);
                }
                else if (elapsedSeconds >= noteEndTime && noteState.state !== 'played-correct' && noteState.state !== 'played-timing-off' && noteState.state !== 'played-note-off') {
                     if (noteState.state !== 'missed') {
                         noteState.state = 'missed';
                         console.log(`Nota ${noteState.midi} (${noteState.id}) mancata al tempo ${elapsedSeconds.toFixed(2)}s (fine attesa: ${noteEndTime.toFixed(2)}s)`);
                     }
                 }
            }
        });
    }

     function highlightPianoKey(midi, className, durationMs = null) {
         const keyElement = document.querySelector(`.key[data-midi="${midi}"]`);
         if (keyElement) {
             const classesToRemove = ['coord-upcoming-right', 'coord-upcoming-left', 'coord-now-right', 'coord-now-left', 'coord-correct', 'coord-incorrect-timing', 'coord-incorrect-note'];
             const index = classesToRemove.indexOf(className);
             if (index > -1) { classesToRemove.splice(index, 1); }
             keyElement.classList.remove(...classesToRemove);
             keyElement.classList.add(className);
             if (durationMs) { setTimeout(() => { if (keyElement.classList.contains(className)) { keyElement.classList.remove(className); } }, durationMs); }
         }
     }

     function clearPianoKeyHighlights() {
         pianoKeys.forEach(key => { key.classList.remove('coord-upcoming-right', 'coord-upcoming-left', 'coord-now-right', 'coord-now-left', 'coord-correct', 'coord-incorrect-timing', 'coord-incorrect-note'); });
     }

    function handleMidiForCoordinationQuiz(midi, velocity, timestamp) {
        if (!isCoordinationQuizActive || !isExerciseRunning || !currentCoordinationExercise) return;

        playNoteSound(midi, velocity);
        const elapsedSeconds = (timestamp - coordinationQuizStartTime) / 1000.0;
        let foundExpectedNote = false;
        let notePlayedState = 'played-note-off';
        let targetNoteState = null;

        targetNoteState = notesInExerciseState.find(noteState => noteState.midi === midi && (noteState.state === 'due' || noteState.state === 'upcoming'));
        if (!targetNoteState) { targetNoteState = notesInExerciseState.find(noteState => noteState.midi === midi && noteState.state === 'pending'); }

        if (targetNoteState) {
            const noteStartTime = targetNoteState.startTimeSeconds;
            const timeDiff = elapsedSeconds - noteStartTime;

            if (Math.abs(timeDiff) <= timingToleranceGood) {
                if (targetNoteState.state !== 'played-correct' && targetNoteState.state !== 'played-timing-off') {
                    foundExpectedNote = true;
                    targetNoteState.playedTimestamp = timestamp;
                    targetNoteState.timingDifference = timeDiff;
                    targetNoteState.isCorrectNote = true;

                    if (Math.abs(timeDiff) <= timingTolerancePerfect) {
                        targetNoteState.state = 'played-correct';
                        notePlayedState = 'played-correct';
                        coordinationQuizScore += 10;
                        coordinationQuizStreak++;
                        coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise.name} - Perfetto! (Rip. ${coordinationCurrentRepetition + 1})`;
                        coordinationQuizStatusDisplay.style.color = 'green';
                        console.log(`Nota ${midi} (${targetNoteState.id}) CORRETTA (Perfetto Timing: ${timeDiff.toFixed(3)}s)`);
                    } else {
                        targetNoteState.state = 'played-timing-off';
                        notePlayedState = 'played-timing-off';
                        coordinationQuizScore += 5;
                        coordinationQuizStreak = 0;
                        coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise.name} - ${timeDiff > 0 ? 'Ritardo' : 'Anticipo'} (Rip. ${coordinationCurrentRepetition + 1})`;
                        coordinationQuizStatusDisplay.style.color = 'orange';
                        console.log(`Nota ${midi} (${targetNoteState.id}) CORRETTA (Timing Off: ${timeDiff.toFixed(3)}s)`);
                    }
                    updateCoordinationScoreDisplay();
                    highlightPianoKey(targetNoteState.midi, notePlayedState.replace('played-', 'coord-'), notePlayedState === 'played-correct' ? 300 : 400);
                } else { console.log(`Nota ${midi} (${targetNoteState.id}) gi√† processata in questa ripetizione.`); }
            } else {
                console.log(`Nota ${midi} (${targetNoteState.id}) corretta ma timing troppo errato (${timeDiff.toFixed(3)}s). Considerata sbagliata.`);
                if (targetNoteState.state !== 'played-correct' && targetNoteState.state !== 'played-timing-off') {
                    targetNoteState.state = 'played-note-off';
                    targetNoteState.playedTimestamp = timestamp;
                    targetNoteState.timingDifference = timeDiff;
                    targetNoteState.isCorrectNote = false;
                }
                foundExpectedNote = false;
                notePlayedState = 'played-note-off';
            }
        }

        if (!foundExpectedNote) {
             console.log(`Nota ${midi} SBAGLIATA o fuori tempo.`);
             coordinationQuizStreak = 0;
             updateCoordinationScoreDisplay();
             coordinationQuizStatusDisplay.textContent = `Esercizio: ${currentCoordinationExercise.name} - Nota sbagliata! (Rip. ${coordinationCurrentRepetition + 1})`;
             coordinationQuizStatusDisplay.style.color = 'red';
             highlightPianoKey(midi, 'coord-incorrect-note', 400);
             if (targetNoteState && targetNoteState.state !== 'played-correct' && targetNoteState.state !== 'played-timing-off') {
                  targetNoteState.state = 'played-note-off';
                  targetNoteState.isCorrectNote = false;
             }
        }
    }
    // ===================================================
    // === FINE CODICE QUIZ COORDINAZIONE MANI =========
    // ===================================================

    // --- Router MIDI Semplificato ---
    function routeMidiMessage(event) {
        const command = event.data[0] & 0xf0;
        const note = event.data[1];
        const velocity = (event.data.length > 2) ? event.data[2] : 0;
        const timestamp = performance.now();

        if (isCoordinationQuizActive) {
             if (command === 0x90 && velocity > 0) {
                 handleMidiForCoordinationQuiz(note, velocity, timestamp);
             }
        } else {
            if (command === 0x90 && velocity > 0) {
                console.log(`MIDI (Inattivo): ${note}`);
                playNoteSound(note, velocity);
            }
        }
    }

    // --- Funzioni Abilita/Disabilita Controlli Quiz ---
    function disableQuizInteractions(disableAll = true) {
        toggleCoordinationQuizBtn.disabled = true;
        if (disableAll) {
            stopCoordinationQuizBtn.disabled = true;
            coordinationBpmSelect.disabled = true;
            coordinationExerciseSelect.disabled = true;
        }
        console.log(`Controlli Quiz DISABILITATI (disableAll: ${disableAll})`);
    }

    function enableQuizInteractions() {
        if (isCoordinationQuizActive) {
             console.log("Controlli Quiz NON RIABILITATI - Quiz attivo.");
             if (!isExerciseRunning) {
                 toggleCoordinationQuizBtn.disabled = false;
                 stopCoordinationQuizBtn.disabled = true;
                 coordinationBpmSelect.disabled = false;
                 coordinationExerciseSelect.disabled = false;
             }
             return;
        }
        toggleCoordinationQuizBtn.disabled = false;
        stopCoordinationQuizBtn.disabled = true;
        coordinationBpmSelect.disabled = false;
        coordinationExerciseSelect.disabled = false;
        console.log("Controlli Quiz RIABILITATI.");
    }

    // --- Inizializzazione ---
    populateExerciseSelect();
    drawStaffSystemHelper(0, 900); // Disegna pentagramma vuoto iniziale
    toggleCoordinationQuizBtn.addEventListener('click', toggleCoordinationQuizMode);
    stopCoordinationQuizBtn.addEventListener('click', handleStopButtonClick);
    coordinationBpmSelect.addEventListener('change', () => {
        if (isCoordinationQuizActive) {
            console.log(`BPM cambiato a ${coordinationBpmSelect.value}. Verr√† applicato alla prossima ripetizione/esercizio.`);
            if (isExerciseRunning) {
                if (metronomeIntervalId) clearInterval(metronomeIntervalId);
                const newBpm = parseInt(coordinationBpmSelect.value, 10) || 80;
                const beatDurationSeconds = 60.0 / newBpm;
                if (beatDurationSeconds > 0) {
                    metronomeIntervalId = setInterval(() => {
                        if (!isCoordinationQuizActive || !isExerciseRunning) { clearInterval(metronomeIntervalId); return; }
                        playMetronomeClick();
                    }, beatDurationSeconds * 1000);
                    console.log(`Metronomo aggiornato a ${newBpm} BPM.`);
                }
            }
        }
    });
    coordinationExerciseSelect.addEventListener('change', () => {
        if (isCoordinationQuizActive && !isExerciseRunning) {
             console.log(`Esercizio selezionato: ${coordinationExerciseSelect.options[coordinationExerciseSelect.selectedIndex].text}. Riattiva il quiz per iniziare.`);
        } else if (isCoordinationQuizActive && isExerciseRunning) {
            console.log(`Selezione esercizio cambiata durante l'esecuzione. Verr√† applicata al prossimo avvio.`);
            // Opzionale: fermare l'esercizio corrente?
            // handleStopButtonClick();
        }
    });

    initializeMIDI();
    console.log("Audio (sintetizzato) in attesa di interazione utente per l'inizializzazione.");
    document.body.addEventListener('click', initAudioContext, { once: true });
    document.body.addEventListener('touchstart', initAudioContext, { once: true });
    updateCoordinationScoreDisplay();

</script>

</body>
</html>